<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Donation TTS</title>
  <style>
    body {
      background: transparent;
      margin: 0;
      overflow: hidden;
    }
    #container {
      position: fixed;
      top: 5%;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 20px 30px;
      font-size: 28px;
      font-family: Arial, sans-serif;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      display: none;
      z-index: 9999;
    }
    #container img {
      height: 80px;
    }
  </style>
</head>
<body>
  <div id="container">
    <img src="/static/animation.gif" alt="donation gif" />
    <span id="donation-text">Dzięki!</span>
  </div>
  <audio id="donation-audio"></audio>

  <script>
    let donationQueue = [];
    let lastSeenIndex = 0;
    let isPlaying = false;

    const container = document.getElementById("container");
    const text = document.getElementById("donation-text");
    const audio = document.getElementById("donation-audio");

    // Na starcie pobieramy długość kolejki i nie gramy starych donejtów
    async function fetchInitialQueueLength() {
      try {
        const res = await fetch("/queue.json");
        const data = await res.json();
        if (Array.isArray(data)) {
          lastSeenIndex = data.length;
        }
      } catch (e) {}
    }

    fetchInitialQueueLength();

    async function fetchDonations() {
      try {
        const res = await fetch("/queue.json");
        const data = await res.json();
        if (!Array.isArray(data)) return;
        if (data.length < lastSeenIndex) {
          lastSeenIndex = data.length;
        }
        // Dodaj tylko nowe donejty
        if (data.length > lastSeenIndex) {
          for (let i = lastSeenIndex; i < data.length; i++) {
            donationQueue.push(data[i]);
          }
          lastSeenIndex = data.length;
          // Zacznij odtwarzać jeśli nic nie gra
          if (!isPlaying) playNext();
        }
      } catch (err) {
        console.error("❌ Fetch error:", err);
      }
    }

    setInterval(fetchDonations, 3000);

    function playNext() {
      if (donationQueue.length === 0) {
        isPlaying = false;
        container.style.display = "none";
        return;
      }
      const next = donationQueue.shift();
      isPlaying = true;

      text.textContent = next.text || "Dzięki!";
      container.style.display = "flex";
      audio.src = "/static/sounds/" + next.audio;
      audio.load();
      audio.play().catch(err => {
        console.error("Audio play error:", err);
        isPlaying = false;
        container.style.display = "none";
        setTimeout(playNext, 500);
      });

      audio.onended = () => {
        isPlaying = false;
        container.style.display = "none";
        setTimeout(playNext, 500);
      };
    }

    // --- audio unlock workaround ---
    function unlockAudio() {
      const emptyAudio = new Audio();
      emptyAudio.src = "data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=";
      emptyAudio.play().catch(() => {});
      window.removeEventListener('click', unlockAudio);
      window.removeEventListener('keydown', unlockAudio);
      window.removeEventListener('scroll', unlockAudio);
      console.log("🔓 Audio odblokowane!");
    }

    window.addEventListener('click', unlockAudio);
    window.addEventListener('keydown', unlockAudio);
    window.addEventListener('scroll', unlockAudio);
  </script>
</body>
</html>
